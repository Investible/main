<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>The Graph API For Investible/Active</title>
    <link href="https://fonts.googleapis.com/css?family=Dosis:400,700" rel="stylesheet">
</head>
<body>
<h1>Graphing for Investment</h1>
<nav th:replace="fragments/navbar :: navbar"></nav>
<p>This page lets you see the ups and down of each company.</p>
<textarea id="searchbox"></textarea>
<input type="button" value="Search!" onclick="doSearch()">
<div id="resultsdiv"></div>

<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript">
    google.charts.load('current', {'packages':['corechart']});
    google.charts.setOnLoadCallback(drawVisualization);

    function drawVisualization() {
        // Some raw data (not necessarily accurate)
        var data = google.visualization.arrayToDataTable([
            ['Company', 'Google', 'Apple', 'Microsoft', 'Qualys', 'Fireye', 'Rapid7', 'Pivotal', 'Twilio', 'Groupon', 'Wayfair', 'Roku', 'Box'],
            ['2015/16',  165,      938,         522,      998,       450,      614.6,    938,       564,      884,     990.0,      450,    575],
            ['2015/16',  135,      1120,        599,     1268,       288,      682,      750,       690,      889,      94,        450,    575],
            ['2016/17',  157,      1167,        587,      807,       397,      623,      687,       104,      650,      893,       450,    575],
            ['2016/17',  157,      1167,        587,      807,       397,      623,      970,       494,      990,      990,       450,    575],
            ['2017/18',  157,      1167,        587,      807,       397,      623,      445,       722,      345,      456,       450,    575],
            ['2017/18',  139,      1110,        615,      968,       215,      609.4,    324,       944,      345,      233,       450,    575],
            ['2018/19',  136,      691,         629,     1026,       366,      569.6,    1000,      774,      345,      145,       450,    575]
        ]);

        var options = {
            title : 'Monthly Investment Production by Company',
            vAxis: {title: 'Stock'},
            hAxis: {title: 'Year'},
            seriesType: 'line',
            series: {12: {type: 'line'}}
        };

        var chart = new google.visualization.LineChart(document.getElementById('graph_charts'));
        chart.draw(data, options);
    }
</script>

<div id="graph_charts" style="width: 900px; height: 500px;"></div>
<div id="news_data"></div>

<script>

    var GRAPHS_CONTAINER = document.querySelector("#graph_charts");

    function getStockGraphData(stockSymbol){
        buildGraphsHTML(stockSymbol)
    }

    async function fetchGraphs(stockSymbol) {
        var url = "https://www.alphavantage.co/query?function=TIME_SERIES_MONTHLY_ADJUSTED&symbol=" + stockSymbol + "&outputsize=full&datatype=json&apikey=N24XNC0U6S1B605Y";

        try {
            var response = await fetch(url)
            var data = await response.json();
            console.log(data);
            var series = data["Monthly Time Series"];

            var output = [
                "month", data["Meta Data"]["2. Symbol"]
            ]

            for (key in series) {
                var price = series[key]["4. close"]
                output.push([key, price])

            }
            console.log(output)
            return data.batch([`MSFT`, `AAPL`, `GOOGL`, `OLYS`,`FEYE`, `RPD`, `TWLO`, `W`, `ROKU`, `BOX`, `PSTG`, `GRPN`]).then(data => {
            });;
        } catch (e) {
            console.log("Error!", e);
        }
    }

    async function buildGraphsHTML(stockSymbol){
        var graphObj = Object.entries(await fetchGraphs(stockSymbol))
        var graphMetaData = graphObj[0][1]
        var graphCompanySymbol = Object.values(graphMetaData)[1]
        var graphTimeSeries = graphObj[1][1]
        console.log(graphCompanySymbol, graphTimeSeries)
        Object.entries(graphTimeSeries).forEach(
            ([key,value]) => console.log(key,value)
        )
        // console.log(graphsHTML)
        GRAPHS_CONTAINER.insertAdjacentHTML('afterbegin', graphsHTML)
    }

    document.addEventListener('DOMContentLoaded', function () {
        // buildGraphsHTML()
        getStockGraphData("MSFT")
    });

</script>
</body>
</html>