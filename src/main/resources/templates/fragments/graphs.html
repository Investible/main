<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>The Graph API For Investible/Active</title>
    <link href="https://fonts.googleapis.com/css?family=Dosis:400,700" rel="stylesheet">
</head>
<body>
<h1>Graphing for Investment</h1>
<nav th:replace="fragments/navbar :: navbar"></nav>
<p>This page lets you see the ups and down of each company.</p>
<textarea id="searchbox"></textarea>
<input type="button" value="Search!" onclick="doSearch()">
<div id="resultsdiv"></div>
<div id="afterbegin"></div>

<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript">
    google.charts.load('current', {'packages':['corechart']});
    // google.charts.setOnLoadCallback(drawVisualization);

    function drawVisualization(output) {
        // Some raw data (grabbing from the api)
        var data = google.visualization.arrayToDataTable(output);
        var options = {
            title : 'Monthly Investment Production by Company',
            vAxis: {title: 'Stock'},
            hAxis: {title: 'Monthly'},
            seriesType: 'line',
            series: {12: {type: 'line'}}
        };

        var chart = new google.visualization.LineChart(document.getElementById('graph_charts'));
        chart.draw(data, options);
    }
</script>

<div id="graph_charts" style="width: 900px; height: 500px;"></div>

<script>

    var GRAPHS_CONTAINER = document.querySelector("#graph_charts");

    function getStockGraphData(stockSymbol){
        fetchGraphs(stockSymbol)
    }
    async function fetchGraphs(stockSymbol) {
        var url = "https://www.alphavantage.co/query?function=TIME_SERIES_MONTHLY&symbol=" + stockSymbol + "&outputsize=full&datatype=json&apikey=4LTMQQHJMWN9C79N";
        try {
            var response = await fetch(url)
            var data = await response.json();
            console.log(data);
            var series = data["Monthly Time Series"];
            var output = [];

            for (key in series) {
                var price = series[key]["4. close"];
                price = parseFloat(price)
                output.push([key, price])
            }
            output.reverse()
            output.unshift(["month", data["Meta Data"]["2. Symbol"]]);

            console.log(output)
            google.charts.setOnLoadCallback(function (){
                drawVisualization(output)
            });

            // return data.batch([`MSFT`, `AAPL`, `GOOGL`, `OLYS`,`FEYE`, `RPD`, `TWLO`, `W`, `ROKU`, `BOX`, `PSTG`, `GRPN`]).then(data => {
            // });;
        } catch (e) {
            console.log("Error!", e);
        }
    }

    // async function buildGraphsHTML(stockSymbol){
    //     var graphObj = Object.entries(await fetchGraphs(stockSymbol));
    //     var graphMetaData = graphObj[0][1];
    //     var graphCompanySymbol = Object.values(graphMetaData)[1];
    //     var graphTimeSeries = graphObj[1][1];
    //     console.log(graphCompanySymbol, graphTimeSeries);
    //     Object.entries(graphTimeSeries).forEach(
    //         ([key,value]) => console.log(key,value)
    //     );
    //     // console.log(graphsHTML);
    //     GRAPHS_CONTAINER.insertAdjacentHTML('afterbegin', graphsHTML)
    // }

    document.addEventListener('DOMContentLoaded', function () {
        // buildGraphsHTML()
        getStockGraphData("GOOGL");
    });

</script>
</body>
</html>